name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Clonar el repositorio
    - uses: actions/checkout@v3

    # 2️⃣ Configurar Python
    - uses: actions/setup-python@v4
      with:
        python-version: 3.11

    # 3️⃣ Instalar dependencias
    - name: Install dependencies
      run: pip install -r requirements.txt

    # 4️⃣ Análisis estático con Ruff
    - name: Run Ruff
      run: ruff .

    # 5️⃣ Tests unitarios
    - name: Run unit tests
      run: pytest tests/unit

    # 6️⃣ Arrancar FastAPI en segundo plano
    - name: Start FastAPI
      run: |
        uvicorn app.main:app --host 127.0.0.1 --port 8000 &
        echo "Waiting for FastAPI to start..."
        sleep 10  # <-- damos 10 segundos para que arranque correctamente

    # 7️⃣ Tests End to End
    - name: Run E2E tests
      run: pytest tests/e2e
